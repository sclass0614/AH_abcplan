<!DOCTYPE html>

<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <title>우리집 DayCareCenter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="./style.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <!-- <script type="module" src="https://sclass0614.github.io/authCheck/authCheck.js"></script> -->


</head>

<body>
    <div id="loadingOverlay">
        <div class="loader"></div>
        <div class="loading-text">데이터를 처리중입니다...</div>
    </div>

    <header id="main-header">
        <h1 id="app-title">
            <i class="fas fa-home header-icon"></i>
            우리집 DayCareCenter
        </h1>
    </header>

    <div id="subcategoryCodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="code-modal-title">소분류코드 선택</h3>
                <span id="close-code-modal" class="close-modal">&times;</span>
            </div>
            <input type="text" id="codeSearchBox" class="search-box" placeholder="코드 검색..." />
            <div class="code-list-container">
                <div class="code-group">
                    <div class="code-group-title">d1 - 학습과지식적용</div>
                    <ul class="code-list">
                        <li data-code="d110">d110-보기</li>
                        <li data-code="d115">d115-듣기</li>
                        <li data-code="d120">d120-기타 의도적 감각</li>
                        <li data-code="d129">d129-기타 상세불명 감각</li>
                        <li data-code="d130">d130-모방하기</li>
                        <li data-code="d135">d135-반복연습하기</li>
                        <li data-code="d137">d137-개념습득하기</li>
                        <li data-code="d140">d140-읽기학습</li>
                        <li data-code="d145">d145-쓰기학습</li>
                        <li data-code="d150">d150-연산학습</li>
                        <li data-code="d155">d155-기술 습득하기</li>
                        <li data-code="d159">d159-기타 기본학습</li>
                        <li data-code="d160">d160-주의집중하기</li>
                        <li data-code="d163">d163-생각하기</li>
                        <li data-code="d166">d166-읽기</li>
                        <li data-code="d170">d170-쓰기</li>
                        <li data-code="d172">d172-계산하기</li>
                        <li data-code="d175">d175-문제해결하기</li>
                        <li data-code="d177">d177-의사결정하기</li>
                        <li data-code="d179">d179-기타 지식적용1</li>
                        <li data-code="d198">d198-기타 지식적용2</li>
                        <li data-code="d199">d199-기타 지식적용3</li>
                    </ul>
                </div>
                <div class="code-group">
                    <div class="code-group-title">d2 - 일반적과제와요구</div>
                    <ul class="code-list">
                        <li data-code="d210">d210-단일 과제수행하기</li>
                        <li data-code="d220">d220-다중 과제수행하기</li>
                        <li data-code="d230">d230-일상생활 수행하기</li>
                        <li data-code="d2301">d2301-일상생활 관리하기</li>
                        <li data-code="d2302">d2302-일상생활 완료하기</li>
                        <li data-code="d2303">d2303-자신의 활동수준 관리하기</li>
                        <li data-code="d2308">d2308-기타 명시된 일상생활 수행하기</li>
                        <li data-code="d2309">d2309-상세불명의 일상생활 수행하기</li>
                        <li data-code="d240">d240-스트레스 관리</li>
                        <li data-code="d298">d298-기타 과제/요구</li>
                        <li data-code="d299">d299-상세불명 과제/요구</li>
                    </ul>
                </div>
                <div class="code-group">
                    <div class="code-group-title">d3 - 의사소통</div>
                    <ul class="code-list">
                        <li data-code="d310">d310-음성 의사소통</li>
                        <li data-code="d315">d315-비언어적 의사소통</li>
                        <li data-code="d320">d320-공식적 수화 의사소통</li>
                        <li data-code="d325">d325-문자메시지로 의사소통</li>
                        <li data-code="d329">d329-기타 의사소통</li>
                        <li data-code="d330">d330-말하기</li>
                        <li data-code="d332">d332-노래부르기</li>
                        <li data-code="d335">d335-비언어적 표현</li>
                        <li data-code="d340">d340-공식적 수화 표현</li>
                        <li data-code="d345">d345-메시지 쓰기</li>
                        <li data-code="d349">d349-기타 의사소통 표현</li>
                        <li data-code="d350">d350-대화</li>
                        <li data-code="d355">d355-토론</li>
                        <li data-code="d360">d360-의사소통장치/기술사용</li>
                        <li data-code="d369">d369-기타소통1</li>
                        <li data-code="d398">d398-기타소통2</li>
                        <li data-code="d399">d399-기타소통3</li>
                    </ul>
                </div>
                <div class="code-group">
                    <div class="code-group-title">d4 - 이동</div>
                    <ul class="code-list">
                        <li data-code="d410">d410-기본자세 바꾸기</li>
                        <li data-code="d415">d415-자세 유지하기</li>
                        <li data-code="d420">d420-자리이동하기</li>
                        <li data-code="d429">d429-기타 자세 바꾸기/유지</li>
                        <li data-code="d430">d430-물건 들고나르기</li>
                        <li data-code="d435">d435-다리로 물건 옮기기</li>
                        <li data-code="d440">d440-손의 섬세한 사용</li>
                        <li data-code="d445">d445-손과팔의사용</li>
                        <li data-code="d449">d449-기타 물건나르기</li>
                        <li data-code="d450">d450-걷기</li>
                        <li data-code="d455">d455-이동하기</li>
                        <li data-code="d460">d460-다양한 장소에서 이동</li>
                        <li data-code="d465">d465-장비를 사용 이동</li>
                        <li data-code="d469">d469-기타 걷기와 이동</li>
                        <li data-code="d470">d470-교통수단 이용하기</li>
                        <li data-code="d475">d475-운전하기</li>
                        <li data-code="d480">d480-교통수단으로서 동물타기</li>
                        <li data-code="d489">d489-기타 교통수단 이용이동</li>
                        <li data-code="d498">d498-기타 명시된 이동</li>
                        <li data-code="d499">d499-상세불명의 이동</li>
                    </ul>
                </div>
                <div class="code-group">
                    <div class="code-group-title">d5 - 자기관리</div>
                    <ul class="code-list">
                        <li data-code="d510">d510-씻기</li>
                        <li data-code="d520">d520-신체일부 관리하기</li>
                        <li data-code="d5200">d5200-피부 관리하기</li>
                        <li data-code="d5201">d5201-치아 관리하기</li>
                        <li data-code="d5202">d5202-털 관리하기</li>
                        <li data-code="d5203">d5203-손톱 관리하기</li>
                        <li data-code="d5204">d5204-발톱 관리하기</li>
                        <li data-code="d5205">d5205-코 관리하기</li>
                        <li data-code="d5208">d5208-기타 명시된 신체일부 관리하기</li>
                        <li data-code="d5209">d5209-상세불명의 신체일부 관리하기</li>
                        <li data-code="d530">d530-용변 관리하기</li>
                        <li data-code="d540">d540-옷입고벗기</li>
                        <li data-code="d550">d550-먹기</li>
                        <li data-code="d560">d560-마시기</li>
                        <li data-code="d570">d570-자신의 건강 돌보기</li>
                        <li data-code="d5700">d5700-신체적 편안함 유지하기</li>
                        <li data-code="d5701">d5701-식습관과 체력 관리하기</li>
                        <li data-code="d5702">d5702-자신의 건강 유지하기</li>
                        <li data-code="d5708">d5708-기타 명시된 자신의 건강 돌보기</li>
                        <li data-code="d5709">d5709-상세불명의 자신의 건강돌보기</li>
                        <li data-code="d598">d598-기타 명시된 자기관리</li>
                        <li data-code="d599">d599-상세불명의 자기관리</li>
                    </ul>
                </div>
                <div class="code-group">
                    <div class="code-group-title">d6 - 가정생활</div>
                    <ul class="code-list">
                        <li data-code="d610">d610-주거 마련하기</li>
                        <li data-code="d620">d620-상품과 서비스획득</li>
                        <li data-code="d629">d629-기타 필수품 마련</li>
                        <li data-code="d630">d630-식사준비하기</li>
                        <li data-code="d6300">d6300-간단한 식사준비하기</li>
                        <li data-code="d6301">d6301-복잡한 식사준비하기</li>
                        <li data-code="d6308">d6308-기타 명시된 식사준비하기</li>
                        <li data-code="d6309">d6309-상세불명의 식사준비하기</li>
                        <li data-code="d640">d640-집안일하기</li>
                        <li data-code="d6400">d6400-옷과 의류 세탁하기와 건조하기</li>
                        <li data-code="d6401">d6401-주방과 조리 기구 세척하기</li>
                        <li data-code="d6402">d6402-주거 공간 청소하기</li>
                        <li data-code="d6403">d6403-가전제품 사용하기</li>
                        <li data-code="d6404">d6404-생필품 보관하기</li>
                        <li data-code="d6405">d6405-쓰레기 처리하기</li>
                        <li data-code="d6408">d6408-기타 명시된 집안일 하기</li>
                        <li data-code="d6409">d6409-상세불명의 집안일하기</li>
                        <li data-code="d649">d649-기타 집안일</li>
                        <li data-code="d650">d650-가정용품 관리하기</li>
                        <li data-code="d6500">d6500-옷 만들기와 수선하기</li>
                        <li data-code="d6501">d6501-주거와 가구류 유지하기</li>
                        <li data-code="d6502">d6502-가전제품 유지하기</li>
                        <li data-code="d6503">d6503-차량 유지하기</li>
                        <li data-code="d6504">d6504-보조장치 유지하기</li>
                        <li data-code="d6505">d6505-실내외 식물 돌보기</li>
                        <li data-code="d6506">d6506-동물 돌보기</li>
                        <li data-code="d6508">d6508-기타 명시된 가정용품 관리하기</li>
                        <li data-code="d6509">d6509-상세불명의 가정용품 관리하기</li>
                        <li data-code="d660">d660-타인 보조하기</li>
                        <li data-code="d6600">d6600-타인의 자기관리 보조하기</li>
                        <li data-code="d6601">d6601-타인의 이동 보조하기</li>
                        <li data-code="d6602">d6602-타인의 의사소통 보조하기</li>
                        <li data-code="d6603">d6603-타인의 대인관계 보조하기</li>
                        <li data-code="d6604">d6604-타인의 영양관리 보조하기</li>
                        <li data-code="d6605">d6605-타인의 건강관리 보조하기</li>
                        <li data-code="d6608">d6608-기타 명시된 타인 보조하기</li>
                        <li data-code="d6609">d6609-상세불명의 타인 보조하기</li>
                        <li data-code="d669">d669-기타 가정용품 타인보조</li>
                        <li data-code="d698">d698-기타 명시된 가정생활</li>
                        <li data-code="d699">d699-상세불명의 가정생활</li>
                    </ul>
                </div>
                <div class="code-group">
                    <div class="code-group-title">d7 - 대인상호작용과대인관계</div>
                    <ul class="code-list">
                        <li data-code="d710">d710-기본적인 대인상호작용</li>
                        <li data-code="d720">d720-복잡한 대인상호작용</li>
                        <li data-code="d729">d729-기타 일반적대인상호작용</li>
                        <li data-code="d730">d730-낯선사람과관계맺기</li>
                        <li data-code="d740">d740-공식적인 관계</li>
                        <li data-code="d750">d750-비공식적인 사회적 관계</li>
                        <li data-code="d760">d760-가족관계</li>
                        <li data-code="d770">d770-친밀한 관계</li>
                        <li data-code="d779">d779-기타 대인1</li>
                        <li data-code="d798">d798-기타 대인2</li>
                        <li data-code="d799">d799-기타 대인3</li>
                    </ul>
                </div>
                <div class="code-group">
                    <div class="code-group-title">d8 - 주요생활영역</div>
                    <ul class="code-list">
                        <li data-code="d810">d810-비공식적인 교육</li>
                        <li data-code="d815">d815-유아교육</li>
                        <li data-code="d820">d820-학교교육</li>
                        <li data-code="d825">d825-직업 훈련하기</li>
                        <li data-code="d830">d830-고등교육</li>
                        <li data-code="d835">d835-교육생활</li>
                        <li data-code="d839">d839-기타 교육</li>
                        <li data-code="d840">d840-견습과정(취업 준비)</li>
                        <li data-code="d845">d845-구직/근속/퇴직</li>
                        <li data-code="d850">d850-유급고용</li>
                        <li data-code="d855">d855-무급고용</li>
                        <li data-code="d859">d859-기타 일과고용</li>
                        <li data-code="d860">d860-기본적인 경제거래</li>
                        <li data-code="d865">d865-복잡한 경제거래</li>
                        <li data-code="d870">d870-경제적 자립</li>
                        <li data-code="d879">d879-기타 경제생활</li>
                        <li data-code="d898">d898-기타 주된 삶의 영역</li>
                        <li data-code="d899">d899-상세불명의 삶의 영역</li>
                    </ul>
                </div>
                <div class="code-group">
                    <div class="code-group-title">d9 - 지역,사회,시민생활</div>
                    <ul class="code-list">
                        <li data-code="d910">d910-지역사회생활</li>
                        <li data-code="d920">d920-레크리에이션과 여가</li>
                        <li data-code="d9200">d9200-놀이</li>
                        <li data-code="d9201">d9201-스포츠</li>
                        <li data-code="d9202">d9202-예술과 문화</li>
                        <li data-code="d9203">d9203-공예</li>
                        <li data-code="d9204">d9204-취미</li>
                        <li data-code="d9205">d9205-사교</li>
                        <li data-code="d9208">d9208-기타 명시된 레크레이션과 여가</li>
                        <li data-code="d9209">d9209-상세불명의 레크레이션과 여가</li>
                        <li data-code="d930">d930-종교및영성</li>
                        <li data-code="d9300">d9300-조직화된 종교</li>
                        <li data-code="d9301">d9301-영성</li>
                        <li data-code="d9308">d9308-기타 명시된 종교 및 영성</li>
                        <li data-code="d9309">d9309-상세불명의 종교 및 영성</li>
                        <li data-code="d940">d940-인권</li>
                        <li data-code="d950">d950-정치생활 및 시민권</li>
                        <li data-code="d998">d998-기타 지역사회생활</li>
                        <li data-code="d999">d999-상세불명 지역사회생활</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>


    <div id="staffSelectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="staff-modal-title">직원명 선택</h3>
                <span id="close-staff-btn" class="close-staff-modal">&times;</span>
            </div>
            <input type="text" id="staffSearchBox" class="search-box" placeholder="직원명 검색 (이름 또는 직원번호)..." />
            <div id="staff-table-container" class="table-container modal-table-container">
                <table class="list-table" id="staff-list-table">
                    <thead>
                        <tr id="staff-list-header">
                            <th>직원번호</th>
                            <th>이름</th>
                        </tr>
                    </thead>
                    <tbody id="staff-list-body">
                    </tbody>
                </table>
            </div>
            <div class="staff-button-container">
                <button id="resetManagerBtn" class="btn-icon">초기화</button>
            </div>
        </div>
    </div>

    <main id="app-main">
        <section class="page active" id="page1">
            <div id="plan-header" class="header-container">
                <h2 id="plan-title">Daily Plan</h2>
                <div id="date-search" class="date-search-container">
                    <div class="input-group" style="display: flex; align-items: center; gap: 5px;">
                        <input type="date" id="datePicker" class="form-control" onchange="makeTable_plan()" />
                        <button type="button" id="btn-plan-search" class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> Update
                        </button>
                    </div>
                </div>
            </div>
            <div id="plan-table-container" class="panel thick-border">
                <div class="table-container">
                    <table class="list-table" id="daily-plan-table">
                        <thead>
                            <tr id="plan-table-header">
                                <th>날짜</th>
                                <th>시작시간</th>
                                <th>종료시간</th>
                                <th>직원명</th>
                                <th>활동명</th>
                                <th>코드</th>
                                <th>활동장소</th>
                                <th>준비물품</th>
                                <th>내용및특이사항</th>
                                <th>활동기록</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="form-panels" class="three-panel">
                <div id="plan-entry-panel" class="panel">
                    <h3 id="plan-entry-title">Plan Entry</h3>
                    <div id="id-date-row" class="row-2col">
                        <div class="col-2">
                            <label id="plan-date-label" for="planDate">날짜(조회)</label>
                            <input type="text" id="planDate" placeholder="우측상단 날짜 선택 후 조회" readonly />
                        </div>
                        <div class="col-2" style="visibility: hidden">
                            <label id="plan-id-label" for="planId">계획_ID(자동입력)</label>
                            <input type="text" id="planId" placeholder="계획_ID 입력중..." readonly />
                        </div>
                    </div>
                    <div id="time-row" class="row-2col">
                        <div class="col-2">
                            <label id="start-time-label" for="startTime">시작시간</label>
                            <input type="text" id="startTime" placeholder="시간 입력중... ex)0920" />
                        </div>
                        <div class="col-2">
                            <label id="end-time-label" for="endTime">종료시간</label>
                            <input type="text" id="endTime" placeholder="시간 입력중... ex)1800" />
                        </div>
                    </div>
                    <div id="activity-row" class="row-2col">
                        <div class="col-2">
                            <label id="activity-name-label" for="activityName">활동명</label>
                            <input type="text" id="activityName" placeholder="활동명 입력중..." />
                        </div>
                        <div class="col-2">
                            <label id="code-label" for="subcategoryCode">소분류코드</label>
                            <input type="text" id="subcategoryCode" placeholder="클릭!" class="clickable-input"
                                readonly />
                        </div>
                    </div>
                    <div id="staff-place-row" class="row-2col">
                        <div class="col-2">
                            <label id="employee-id-label" for="employeeId">직원번호</label>
                            <input type="text" id="employeeId" placeholder="직원명 클릭" readonly />
                        </div>
                        <div class="col-2">
                            <label id="manager-label" for="manager">직원명</label>
                            <input type="text" id="manager" placeholder="클릭!" readonly />
                        </div>
                    </div>
                    <div id="activity-place-row" class="row-2col">
                        <div class="col-2">
                            <label id="place-label" for="activityPlace">활동장소</label>
                            <input type="text" id="activityPlace" placeholder="활동장소 입력중..." />
                        </div>
                        <div class="col-2">
                            <label id="preparation-label" for="preparation">준비물</label>
                            <input type="text" id="preparation" placeholder="준비물 입력중..." />
                        </div>
                    </div>
                    <label id="details-label" for="details">내용및특이사항</label>
                    <input type="text" id="details" placeholder="내용 및 특이사항 입력중..." />
                    <label id="image-url-label" for="imageUrl">참고사진URL</label>
                    <input type="text" id="imageUrl" placeholder="클릭!" readonly class="clickable-input" />
                </div>

                <div id="result-entry-panel" class="panel">
                    <h3 id="result-entry-title">Result Entry</h3>
                    <textarea id="resultEntryTextarea" rows="14" placeholder="결과 내용을 입력..."></textarea>
                </div>

                <div id="notice-panel" class="panel relative-panel">
                    <h3 id="notice-title">Notice</h3>
                    <textarea id="noticeTextarea" rows="14" placeholder="누락된 사항이 없습니다." class="notice-textarea"
                        readonly></textarea>
                    <div id="form-buttons" class="bottom-buttons absolute-buttons">
                        <button id="btn-plan-reset" onclick="resetAllFields()">
                            초기화
                        </button>
                        <button id="btn-plan-save">저장</button>
                        <button id="btn-plan-modify">
                            수정
                        </button>
                        <button id="btn-plan-delete">삭제</button>
                    </div>
                </div>
            </div>
        </section>
        <div id="customConfirm" class="custom-alert">
            <div id="confirm-content" class="custom-alert-content">
                <div id="confirm-header" class="custom-alert-header confirm-header">
                    <i id="confirm-icon" class="fas fa-exclamation-triangle"></i>
                    <span id="confirm-title">확인</span>
                    <button id="close-confirm-x" onclick="closeCustomConfirm(false)" class="close-alert">
                        &times;
                    </button>
                </div>
                <div id="confirm-body" class="custom-alert-body">
                    <p id="customConfirmMessage"></p>
                </div>
                <div id="confirm-footer" class="custom-alert-footer">
                    <button id="confirm-cancel-btn" onclick="closeCustomConfirm(false)" class="alert-cancel-btn">
                        취소
                    </button>
                    <button id="confirm-ok-btn" onclick="closeCustomConfirm(true)"
                        class="alert-confirm-btn confirm-btn">
                        확인
                    </button>
                </div>
            </div>
        </div>
        <div id="customAlert" class="custom-alert">
            <div id="alert-content" class="custom-alert-content">
                <div id="alert-header" class="custom-alert-header">
                    <i id="alert-icon" class="fas fa-info-circle"></i>
                    <span id="alert-title">알림</span>
                    <button id="close-alert-x" onclick="closeCustomAlert()" class="close-alert">
                        &times;
                    </button>
                </div>
                <div id="alert-body" class="custom-alert-body">
                    <p id="customAlertMessage"></p>
                </div>
                <div id="alert-footer" class="custom-alert-footer">
                    <button id="alert-ok-btn" onclick="closeCustomAlert()" class="alert-confirm-btn">
                        확인
                    </button>
                </div>
            </div>
        </div>


    </main>

    <script>
        function showLoading() {
            document.getElementById("loadingOverlay").style.display = "flex";
        }

        function hideLoading() {
            document.getElementById("loadingOverlay").style.display = "none";
        }

        let employeeall = [];

        async function getPlanAllPromise() {
            return await getPlanAll();
        }

        async function getEmployeesPromise() {
            return await getAllEmployees();
        }

        async function appendPlanPromise(planData) {
            return await appendPlan(planData);
        }

        async function updatePlanPromise(planId, planData) {
            return await updatePlan(planId, planData);
        }

        async function deletePlanPromise(planId) {
            return await deletePlanrow(planId);
        }

        async function initialize() {
            showLoading();

            try {
                employeeall = await getEmployeesPromise();
                makeTable_plan();
            } catch (error) {
                console.error("초기화 중 오류 발생:", error);
                showCustomAlert("데이터를 불러오는데 실패했습니다: " + error);
            } finally {
                hideLoading();
            }
        }

        async function getPlanAll_id() {
            showLoading();
            try {
                await makeTable_plan();
            } catch (error) {
                console.error("데이터 로드 실패:", error);
                showCustomAlert("데이터를 불러오는데 실패했습니다: " + error);
            } finally {
                hideLoading();
            }
        }

        async function loadStaffList() {
            showLoading();
            try {
                employeeall = await getEmployeesPromise();
            } catch (error) {
                console.error("직원 데이터 로드 실패:", error);
                showCustomAlert("직원 데이터를 불러오는데 실패했습니다: " + error);
            } finally {
                hideLoading();
            }
        }

        async function appendPlan_id() {
            showLoading();
            try {
                const startTime = String(document.getElementById("startTime").value).padStart(4, '0');
                const endTime = String(document.getElementById("endTime").value).padStart(4, '0');

                const planData = [
                    "",
                    document.getElementById("planDate").value,
                    "'" + startTime,
                    "'" + endTime,
                    document.getElementById("employeeId").value,
                    document.getElementById("manager").value,
                    document.getElementById("activityName").value,
                    document.getElementById("subcategoryCode").value,
                    document.getElementById("activityPlace").value,
                    document.getElementById("preparation").value,
                    document.getElementById("details").value,
                    document.getElementById("resultEntryTextarea").value,
                    document.getElementById("imageUrl").value
                ];

                await appendPlanPromise(planData);
                showCustomAlert("계획이 성공적으로 저장되었습니다.");
                await getPlanAll_id();
            } catch (error) {
                showCustomAlert("저장 중 오류가 발생했습니다: " + error);
            } finally {
                hideLoading();
            }
        }

        async function deletePlanrow_id() {
            showLoading();
            try {
                const planId = document.getElementById("planId").value;

                if (!planId) {
                    showCustomAlert("삭제할 계획을 선택해주세요.");
                    return;
                }

                await deletePlanPromise(planId);
                showCustomAlert("계획이 성공적으로 삭제되었습니다.");
                await getPlanAll_id();
                resetAllFields();
            } catch (error) {
                showCustomAlert("삭제 중 오류가 발생했습니다: " + error);
            } finally {
                hideLoading();
            }
        }

        async function modifyPlan_id() {
            showLoading();
            try {
                const planId = document.getElementById("planId").value;

                if (!planId) {
                    showCustomAlert("수정할 계획을 선택해주세요.");
                    return;
                }

                const startTime = String(document.getElementById("startTime").value).padStart(4, '0');
                const endTime = String(document.getElementById("endTime").value).padStart(4, '0');

                const planData = [
                    planId,
                    document.getElementById("planDate").value,
                    "'" + startTime,
                    "'" + endTime,
                    document.getElementById("employeeId").value,
                    document.getElementById("manager").value,
                    document.getElementById("activityName").value,
                    document.getElementById("subcategoryCode").value,
                    document.getElementById("activityPlace").value,
                    document.getElementById("preparation").value,
                    document.getElementById("details").value,
                    document.getElementById("resultEntryTextarea").value,
                    document.getElementById("imageUrl").value
                ];

                await updatePlanPromise(planId, planData);
                showCustomAlert("계획이 성공적으로 수정되었습니다.");
                await getPlanAll_id();
                resetAllFields();
            } catch (error) {
                showCustomAlert("수정 중 오류가 발생했습니다: " + error);
            } finally {
                hideLoading();
            }
        }

        function changeDate(dateStr) {
            if (!dateStr) return '';

            if (typeof dateStr !== 'string') {
                dateStr = String(dateStr);
            }

            return dateStr.replace(/-/g, "");
        }

        function entryCheck() {
            const tableBody = document.getElementById("table-body");
            const rows = tableBody.getElementsByTagName("tr");
            let missingEntries = [];

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName("td");
                if (cells.length > 0) {
                    const startTime = cells[1].textContent.trim();
                    const manager = cells[3].textContent.trim();
                    const activity = cells[4].textContent.trim();
                    const record = cells[9].textContent.trim();

                    if (!record) {
                        missingEntries.push(`「${startTime}_${manager}_${activity}」`);
                    }
                }
            }

            const noticeTextarea = document.getElementById("noticeTextarea");
            if (missingEntries.length > 0) {
                const message = "다음의 활동 기록이 누락되었습니다 : \n\n" + missingEntries.join('\n');
                noticeTextarea.value = message;
            } else {
                noticeTextarea.value = '모든 활동의 기록이 작성되었습니다.';
            }
        }

        async function makeTable_plan() {
            const selectedDate = changeDate(
                document.getElementById("datePicker").value
            );

            if (!selectedDate) {
                return;
            }

            showLoading();

            try {
                const formattedDate = selectedDate.slice(0, 4) + '-' + selectedDate.slice(4, 6) + '-' + selectedDate.slice(6, 8);

                const filteredPlans = await getPlanAll(formattedDate);

                filteredPlans.sort((a, b) => {
                    const timeA = a[2].replace(/'/g, "");
                    const timeB = b[2].replace(/'/g, "");
                    if (timeA !== timeB) {
                        return timeA.localeCompare(timeB);
                    }
                    return a[5].localeCompare(b[5]);
                });

                const tableBody = document.getElementById("table-body");
                tableBody.innerHTML = "";

                if (filteredPlans.length === 0) {
                    const emptyRow = document.createElement("tr");
                    const emptyCell = document.createElement("td");
                    emptyCell.colSpan = 10;
                    emptyCell.textContent = "해당 날짜의 계획 데이터가 없습니다.";
                    emptyCell.style.textAlign = "center";
                    emptyCell.style.padding = "20px";
                    emptyRow.appendChild(emptyCell);
                    tableBody.appendChild(emptyRow);

                    document.getElementById("planDate").value = selectedDate;

                    document.getElementById("noticeTextarea").value = "";
                    return;
                }

                displaySortedData(filteredPlans);

                document.getElementById("planDate").value = selectedDate;

                resetAllFields();

                entryCheck();
            } catch (error) {
                console.error("계획 데이터 로드 중 오류 발생:", error);
                alert("계획 데이터를 불러오는 중 오류가 발생했습니다.");
            } finally {
                hideLoading();
            }
        }

        let currentSortColumn = 1;
        let isAscending = true;

        function displaySortedData(data) {
            const tableBody = document.getElementById("table-body");
            tableBody.innerHTML = "";

            data.forEach((plan) => {
                const row = document.createElement("tr");

                const columns = [1, 2, 3, 5, 6, 7, 8, 9, 10, 11];

                columns.forEach((index) => {
                    const cell = document.createElement("td");
                    cell.textContent = plan[index] || "";
                    row.appendChild(cell);
                });

                row.addEventListener("dblclick", function () {
                    fillPlanFields(plan);
                });

                tableBody.appendChild(row);
            });
        }

        document.addEventListener("DOMContentLoaded", function () {

            const headers = document.querySelectorAll("#plan-table-header th");
            headers.forEach((header, index) => {
                header.style.cursor = "pointer";
                header.addEventListener("click", () => sortTable(index));
            });
        });

        async function sortTable(columnIndex) {
            const selectedDate = changeDate(document.getElementById("datePicker").value);
            
            if (!selectedDate) {
                return;
            }

            showLoading();
            
            try {
                const formattedDate = selectedDate.slice(0, 4) + '-' + selectedDate.slice(4, 6) + '-' + selectedDate.slice(6, 8);
                
                let filteredPlans = await getPlanAll(formattedDate);

                if (columnIndex === currentSortColumn) {
                    isAscending = !isAscending;
                } else {
                    currentSortColumn = columnIndex;
                    isAscending = true;
                }

                const dataIndexMap = [1, 2, 3, 5, 6, 7, 8, 9, 10, 11];
                const dataIndex = dataIndexMap[columnIndex];

                filteredPlans.sort((a, b) => {
                    let valueA = (a[dataIndex] || "").toString().replace(/'/g, "");
                    let valueB = (b[dataIndex] || "").toString().replace(/'/g, "");

                    if (dataIndex === 2 || dataIndex === 3) {
                        valueA = valueA.padStart(4, '0');
                        valueB = valueB.padStart(4, '0');
                    }

                    if (isAscending) {
                        return valueA.localeCompare(valueB);
                    } else {
                        return valueB.localeCompare(valueA);
                    }
                });

                displaySortedData(filteredPlans);
            } catch (error) {
                console.error("정렬 중 오류 발생:", error);
                alert("데이터를 불러오는 중 오류가 발생했습니다.");
            } finally {
                hideLoading();
            }
        }

        function fillPlanFields(plan) {
            document.getElementById("planId").value = plan[0] || "";
            document.getElementById("planDate").value = plan[1] || "";
            document.getElementById("startTime").value = (plan[2] || "").replace(/'/g, "").padStart(4, '0');
            document.getElementById("endTime").value = (plan[3] || "").replace(/'/g, "").padStart(4, '0');
            document.getElementById("employeeId").value = plan[4] || "";
            document.getElementById("manager").value = plan[5] || "";
            document.getElementById("activityName").value = plan[6] || "";
            document.getElementById("subcategoryCode").value = plan[7] || "";
            document.getElementById("activityPlace").value = plan[8] || "";
            document.getElementById("preparation").value = plan[9] || "";
            document.getElementById("details").value = plan[10] || "";
            document.getElementById("resultEntryTextarea").value = plan[11] || "";
            document.getElementById("imageUrl").value = plan[12] || "";

            updateButtonStates(false, true, true);
        }

        function updateButtonStates(saveEnabled, modifyEnabled, deleteEnabled) {
            document.getElementById("btn-plan-save").disabled = !saveEnabled;
            document.getElementById("btn-plan-modify").disabled = !modifyEnabled;
            document.getElementById("btn-plan-delete").disabled = !deleteEnabled;
        }

        function filterCodes(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            const codeListItems = document.querySelectorAll(".code-list li");

            if (searchTerm === "") {
                document
                    .querySelectorAll(".code-group")
                    .forEach((group) => (group.style.display = ""));
                codeListItems.forEach((item) => (item.style.display = ""));
            } else {
                document.querySelectorAll(".code-group").forEach((group) => {
                    group.style.display = "";
                    const items = group.querySelectorAll(".code-list li");
                    let hasVisibleItems = false;
                    items.forEach((item) => {
                        const text = item.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            item.style.display = "";
                            hasVisibleItems = true;
                        } else {
                            item.style.display = "none";
                        }
                    });
                    if (!hasVisibleItems) group.style.display = "none";
                });
            }
        }

        function resetAllFields() {
            document.getElementById("planId").value = "";
            document.getElementById("startTime").value = "";
            document.getElementById("endTime").value = "";
            document.getElementById("employeeId").value = "";
            document.getElementById("activityName").value = "";
            document.getElementById("subcategoryCode").value = "";
            document.getElementById("manager").value = "";
            document.getElementById("activityPlace").value = "";
            document.getElementById("preparation").value = "";
            document.getElementById("details").value = "";
            document.getElementById("resultEntryTextarea").value = "";
            document.getElementById("imageUrl").value = "";

            updateButtonStates(true, false, false);
        }

        function showCustomAlert(message) {
            document.getElementById("customAlertMessage").textContent = message;
            document.getElementById("customAlert").style.display = "flex";
        }

        function closeCustomAlert() {
            document.getElementById("customAlert").style.display = "none";
        }

        function showCustomConfirm(message, onConfirm) {
            document.getElementById("customConfirmMessage").textContent = message;
            document.getElementById("customConfirm").style.display = "flex";

            document.getElementById("confirm-ok-btn").onclick = function () {
                closeCustomConfirm(true);
                if (typeof onConfirm === 'function') {
                    onConfirm();
                }
            };
        }

        function closeCustomConfirm(confirmed) {
            document.getElementById("customConfirm").style.display = "none";
            return confirmed;
        }

        async function validatePlanInputs() {
            const requiredFields = [
                { id: "planDate", name: "날짜" },
                { id: "startTime", name: "시작시간" },
                { id: "endTime", name: "종료시간" },
                { id: "activityName", name: "활동명" },
                { id: "subcategoryCode", name: "소분류코드" },
                { id: "employeeId", name: "직원번호" },
                { id: "manager", name: "직원명" },
                { id: "activityPlace", name: "활동장소" },
                { id: "preparation", name: "준비물" },
                { id: "details", name: "내용및특이사항" }
            ];

            for (const field of requiredFields) {
                const value = document.getElementById(field.id).value.trim();
                if (!value) {
                    showCustomAlert(`${field.name}을(를) 입력해주세요.`);
                    document.getElementById(field.id).focus();
                    return false;
                }
            }

            const imageUrl = document.getElementById("imageUrl").value.trim();

            if (imageUrl !== "") {
                if (!imageUrl.startsWith("https://")) {
                    showCustomAlert("참고사진URL은 https://로 시작해야 합니다.");
                    document.getElementById("imageUrl").focus();
                    return false;
                }
            }

            const timeRegex = /^([0-1][0-9]|2[0-3])[0-5][0-9]$/;
            let startTime = document.getElementById("startTime").value.padStart(4, '0');
            let endTime = document.getElementById("endTime").value.padStart(4, '0');

            if (!timeRegex.test(startTime)) {
                showCustomAlert("시작시간을 올바른 형식(HHMM)으로 입력해주세요.\n예: 0900, 1330");
                document.getElementById("startTime").focus();
                return false;
            }

            if (!timeRegex.test(endTime)) {
                showCustomAlert("종료시간을 올바른 형식(HHMM)으로 입력해주세요.\n예: 0900, 1330");
                document.getElementById("endTime").focus();
                return false;
            }

            if (parseInt(startTime) >= parseInt(endTime)) {
                showCustomAlert("종료시간은 시작시간보다 늦어야 합니다.");
                document.getElementById("endTime").focus();
                return false;
            }

            const dateRegex = /^[0-9]{8}$/;
            const planDate = document.getElementById("planDate").value;

            if (!dateRegex.test(planDate)) {
                showCustomAlert("날짜 형식이 올바르지 않습니다. (YYYYMMDD)");
                return false;
            }

            const currentPlanId = document.getElementById("planId").value;
            if (!(await checkRightTime(planDate, startTime, endTime, currentPlanId))) {
                return false;
            }

            return true;
        }

        async function checkRightTime(planDate, startTime, endTime, currentPlanId) {
            const inputStartMinutes = convertTimeToMinutes(startTime);
            const inputEndMinutes = convertTimeToMinutes(endTime);

            try {
                const formattedDate = planDate.slice(0, 4) + '-' + planDate.slice(4, 6) + '-' + planDate.slice(6, 8);
                
                const sameDatePlans = await getPlanAll(formattedDate);

                for (const plan of sameDatePlans) {
                    if (currentPlanId && plan[0] === currentPlanId) {
                        continue;
                    }

                    const planStartTime = plan[2].replace(/'/g, "").padStart(4, '0');
                    const planEndTime = plan[3].replace(/'/g, "").padStart(4, '0');
                    const planStartMinutes = convertTimeToMinutes(planStartTime);
                    const planEndMinutes = convertTimeToMinutes(planEndTime);

                    if (planStartMinutes === inputStartMinutes && planEndMinutes === inputEndMinutes) {
                        continue;
                    }

                    if ((inputStartMinutes >= planStartMinutes && inputStartMinutes < planEndMinutes) ||
                        (inputEndMinutes > planStartMinutes && inputEndMinutes <= planEndMinutes) ||
                        (inputStartMinutes <= planStartMinutes && inputEndMinutes >= planEndMinutes)) {

                        const planStartTimeFormatted = formatTime(planStartTime);
                        const planEndTimeFormatted = formatTime(planEndTime);
                        const staffName = plan[5];

                        showCustomAlert(`입력한 시간이 ${staffName}님의 기존 계획 (${planStartTimeFormatted}~${planEndTimeFormatted})과 중복됩니다.`);
                        return false;
                    }
                }

                return true;
            } catch (error) {
                console.error("시간 중복 검사 중 오류 발생:", error);
                return true;
            }
        }

        function convertTimeToMinutes(timeStr) {
            const hours = parseInt(timeStr.substring(0, 2));
            const minutes = parseInt(timeStr.substring(2, 4));
            return hours * 60 + minutes;
        }

        function formatTime(timeStr) {
            return `${timeStr.substring(0, 2)}:${timeStr.substring(2, 4)}`;
        }

        document.addEventListener("DOMContentLoaded", function () {
            initSupabase();

            const today = new Date().toISOString().split("T")[0];
            document.getElementById("datePicker").value = today;

            updateButtonStates(true, false, false);

            initialize();

            document.getElementById("subcategoryCode").addEventListener("click", function () {
                document.getElementById("subcategoryCodeModal").style.display = "block";
            });

            document.getElementById("close-code-modal").addEventListener("click", function () {
                document.getElementById("subcategoryCodeModal").style.display = "none";
            });

            document.getElementById("codeSearchBox").addEventListener("input", function () {
                filterCodes(this.value);
            });

            document.querySelectorAll(".code-list li").forEach(function (item) {
                item.addEventListener("dblclick", function () {
                    document.getElementById("subcategoryCode").value = this.textContent;
                    document.getElementById("subcategoryCodeModal").style.display = "none";
                });
            });

            window.addEventListener("click", function (event) {
                const modal = document.getElementById("subcategoryCodeModal");
                if (event.target === modal) {
                    modal.style.display = "none";
                }

                const staffModal = document.getElementById("staffSelectModal");
                if (event.target === staffModal) {
                    staffModal.style.display = "none";
                }

                const picModalBackdrop = document.getElementById("picModalBackdrop");
                if (event.target === picModalBackdrop) {
                    const picModal = document.getElementById("picModal");
                    if (picModal.style.display === "block") {
                        picModal.style.display = "none";
                    }
                    else {
                        closePicManagerModal();
                    }
                }
            });

            document.getElementById("manager").addEventListener("click", function () {
                document.getElementById("staffSelectModal").style.display = "block";
                populateStaffTable(employeeall);
            });

            document.getElementById("close-staff-btn").addEventListener("click", function () {
                document.getElementById("staffSelectModal").style.display = "none";
            });

            document.getElementById("staffSearchBox").addEventListener("input", function () {
                filterStaffList(this.value);
            });

            document.getElementById("resetManagerBtn").addEventListener("click", function () {
                showCustomConfirm("선택된 모든 직원명를 초기화하시겠습니까?", function () {
                    document.getElementById("employeeId").value = "";
                    document.getElementById("manager").value = "";
                    document.getElementById("staffSelectModal").style.display = "none";
                });
            });

            document.getElementById("btn-plan-save").addEventListener("click", async function () {
                const isValid = await validatePlanInputs();

                if (isValid) {
                    showCustomConfirm("계획을 저장하시겠습니까?", function () {
                        appendPlan_id();
                    });
                }
            });

            document.getElementById("btn-plan-modify").addEventListener("click", async function () {
                const isValid = await validatePlanInputs();

                if (isValid) {
                    showCustomConfirm("선택한 계획을 수정하시겠습니까?", function () {
                        modifyPlan_id();
                    });
                }
            });

            document.getElementById("btn-plan-delete").addEventListener("click", function () {
                const planId = document.getElementById("planId").value;

                if (!planId) {
                    showCustomAlert("삭제할 계획을 선택해주세요.");
                    return;
                }

                showCustomConfirm("선택한 계획을 삭제하시겠습니까?", function () {
                    deletePlanrow_id();
                });
            });

            document.getElementById("btn-plan-search").addEventListener("click", function () {
                getPlanAll_id();
            });

            document.getElementById("imageUrl").addEventListener("click", function () {
                openPicManagerModal();
            });

            if (document.getElementById("picManagerCloseButton")) {
                document.getElementById("picManagerCloseButton").addEventListener("click", closePicManagerModal);
            }

            if (document.getElementById("picAddButton")) {
                document.getElementById("picAddButton").addEventListener("click", openNewModal);
            }

            if (document.getElementById("picCancelInputButton")) {
                document.getElementById("picCancelInputButton").addEventListener("click", function () {
                    document.getElementById("imageUrl").value = "";
                    closePicManagerModal();
                });
            }

            if (document.getElementById("picCloseButton")) {
                document.getElementById("picCloseButton").addEventListener("click", closeModal);
            }

            if (document.getElementById("picCancelButton")) {
                document.getElementById("picCancelButton").addEventListener("click", closeModal);
            }

            if (document.getElementById("picConfirmButton")) {
                document.getElementById("picConfirmButton").addEventListener("click", handleConfirm);
            }

            if (document.getElementById("picPreviewButton")) {
                document.getElementById("picPreviewButton").addEventListener("click", previewImage);
            }

            if (document.getElementById("picFilterInput")) {
                document.getElementById("picFilterInput").addEventListener("input", handleFilterInput);
            }

            if (document.getElementById("picFilterClearButton")) {
                document.getElementById("picFilterClearButton").addEventListener("click", clearFilter);
            }
        });

        function populateStaffTable(staffData) {
            const tableBody = document.getElementById("staff-list-body");
            tableBody.innerHTML = "";

            const selectedDate = changeDate(document.getElementById("datePicker").value);

            let filteredStaff = [];

            for (let i = 1; i < staffData.length; i++) {
                const startDate = staffData[i][2] || "";
                const endDate = staffData[i][3] || "";

                if (startDate && selectedDate >= startDate &&
                    (!endDate || selectedDate <= endDate)) {
                    filteredStaff.push(staffData[i]);
                }
            }

            filteredStaff.sort((a, b) => {
                const nameA = a[1] || "";
                const nameB = b[1] || "";
                return nameA.localeCompare(nameB);
            });

            for (let i = 0; i < filteredStaff.length; i++) {
                const row = document.createElement("tr");

                const idCell = document.createElement("td");
                idCell.textContent = filteredStaff[i][0] || "";

                const nameCell = document.createElement("td");
                nameCell.textContent = filteredStaff[i][1] || "";

                row.appendChild(idCell);
                row.appendChild(nameCell);

                row.addEventListener("dblclick", function () {
                    const currentEmployeeId = document.getElementById("employeeId").value;
                    const currentManager = document.getElementById("manager").value;
                    const newEmployeeId = filteredStaff[i][0] || "";
                    const newManager = filteredStaff[i][1] || "";

                    if (currentManager.split(",").map(m => m.trim()).includes(newManager)) {
                        showCustomAlert("이미 선택된 직원명입니다.");
                        return;
                    }

                    document.getElementById("employeeId").value = currentEmployeeId
                        ? currentEmployeeId + ", " + newEmployeeId
                        : newEmployeeId;

                    document.getElementById("manager").value = currentManager
                        ? currentManager + ", " + newManager
                        : newManager;

                    document.getElementById("staffSelectModal").style.display = "none";
                });

                tableBody.appendChild(row);
            }

            if (filteredStaff.length === 0) {
                const row = document.createElement("tr");
                const cell = document.createElement("td");
                cell.colSpan = 2;
                cell.textContent = "선택한 날짜에 해당하는 재직 중인 직원이 없습니다.";
                cell.style.textAlign = "center";
                cell.style.padding = "20px";
                row.appendChild(cell);
                tableBody.appendChild(row);
            }
        }

        function filterStaffList(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            const rows = document.querySelectorAll("#staff-list-body tr");

            rows.forEach(function (row) {
                const empId = row.children[0].textContent.toLowerCase();
                const empName = row.children[1].textContent.toLowerCase();

                if (empId.includes(searchTerm) || empName.includes(searchTerm)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        let currentRowId = null;
        let isEditing = false;
        let isViewOnly = false;
        let allActivityData = [];

        function openPicManagerModal() {
            const picManagerSystem = document.getElementById('picManagerSystem');
            const picModalBackdrop = document.getElementById('picModalBackdrop');
            const picManagerModal = document.getElementById('picManagerModal');

            picManagerSystem.style.display = 'block';
            picModalBackdrop.style.display = 'block';
            picManagerModal.style.display = 'block';

            clearFilter();

            refreshTable();
        }

        function closePicManagerModal() {
            const picManagerSystem = document.getElementById('picManagerSystem');
            const picModalBackdrop = document.getElementById('picModalBackdrop');
            const picManagerModal = document.getElementById('picManagerModal');

            picManagerSystem.style.display = 'none';
            picModalBackdrop.style.display = 'none';
            picManagerModal.style.display = 'none';

            closeModal();
        }

        function refreshTable() {
            fetchActivityPics()
                .then(data => {
                    allActivityData = data || [];

                    allActivityData.sort((a, b) => {
                        return a.활동명.localeCompare(b.활동명, 'ko-KR');
                    });

                    const filterValue = document.getElementById('picFilterInput').value.trim().toLowerCase();
                    if (filterValue) {
                        filterTable(filterValue);
                    } else {
                        renderFilteredTable(allActivityData, '');
                    }
                })
                .catch(error => {
                    console.error('테이블 로드 오류:', error);
                    showCustomAlert('데이터를 불러오는 중 오류가 발생했습니다.');
                });
        }

        function truncateUrl(url) {
            return url.length > 30 ? url.substring(0, 30) + '...' : url;
        }

        function openNewModal() {
            resetModal();
            isEditing = false;
            isViewOnly = false;
            currentRowId = null;

            document.getElementById('picActivityName').readOnly = false;
            document.getElementById('picUrl').readOnly = false;
            document.getElementById('picPreviewButton').disabled = false;

            document.getElementById('picModal').style.display = 'block';
            document.getElementById('picActivityName').focus();
        }

        function openViewModal(id, activityName, url) {
            resetModal();
            isEditing = false;
            isViewOnly = true;
            currentRowId = id;

            document.getElementById('picActivityName').value = activityName;
            document.getElementById('picUrl').value = url;

            document.getElementById('picActivityName').readOnly = true;
            document.getElementById('picUrl').readOnly = true;
            document.getElementById('picPreviewButton').disabled = true;

            if (url) {
                document.getElementById('picPreviewImage').src = url;
            }

            document.getElementById('picPreviewContainer').style.display = 'block';

            document.getElementById('picModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('picModal').style.display = 'none';
            resetModal();
        }

        function resetModal() {
            document.getElementById('picActivityName').value = '';
            document.getElementById('picUrl').value = '';
            document.getElementById('picPreviewImage').src = '';

            document.getElementById('picActivityName').readOnly = false;
            document.getElementById('picUrl').readOnly = false;
            document.getElementById('picPreviewButton').disabled = false;

            isViewOnly = false;
        }

        function previewImage() {
            const url = document.getElementById('picUrl').value.trim();
            const picPreviewImage = document.getElementById('picPreviewImage');

            if (!url) {
                picPreviewImage.src = '';
                return;
            }

            picPreviewImage.src = url;

            picPreviewImage.onerror = function () {
                console.error('이미지를 불러올 수 없습니다:', url);
                picPreviewImage.src = '';
            };
        }

        function handleFilterInput() {
            const picFilterInput = document.getElementById('picFilterInput');
            const picFilterClearButton = document.getElementById('picFilterClearButton');
            const filterValue = picFilterInput.value.trim().toLowerCase();

            picFilterClearButton.style.display = filterValue ? 'block' : 'none';

            filterTable(filterValue);
        }

        function clearFilter() {
            const picFilterInput = document.getElementById('picFilterInput');
            const picFilterClearButton = document.getElementById('picFilterClearButton');

            picFilterInput.value = '';
            picFilterClearButton.style.display = 'none';
            filterTable('');
        }

        function filterTable(filterValue) {
            if (!allActivityData.length) return;

            const filteredData = filterValue
                ? allActivityData.filter(item =>
                    item.활동명.toLowerCase().includes(filterValue))
                : allActivityData;

            renderFilteredTable(filteredData, filterValue);
        }

        function renderFilteredTable(data, filterValue) {
            const picTableBody = document.getElementById('picTableBody');
            picTableBody.innerHTML = '';

            if (!data || data.length === 0) {
                const emptyRow = document.createElement('tr');

                if (filterValue) {
                    emptyRow.innerHTML = `<td colspan="3" class="pic-no-results">검색 결과가 없습니다: "${filterValue}"</td>`;
                } else {
                    emptyRow.innerHTML = '<td colspan="3" style="text-align: center;">데이터가 없습니다.</td>';
                }

                picTableBody.appendChild(emptyRow);
                return;
            }

            data.forEach(item => {
                const row = document.createElement('tr');
                row.classList.add('pic-clickable');
                row.setAttribute('data-id', item.pic_id);
                row.setAttribute('data-activity-name', item.활동명);
                row.setAttribute('data-pic-url', item.url주소);

                let displayName = item.활동명;
                if (filterValue) {
                    const regex = new RegExp(`(${filterValue})`, 'gi');
                    displayName = displayName.replace(regex, '<span class="pic-highlight">$1</span>');
                }

                row.innerHTML = `
                    <td>${displayName}</td>
                    <td class="url-cell">${truncateUrl(item.url주소)}</td>
                    <td>
                        <button class="button danger pic-delete-button" data-id="${item.pic_id}">삭제</button>
                    </td>
                `;

                picTableBody.appendChild(row);

                row.addEventListener('dblclick', function () {
                    const id = this.getAttribute('data-id');
                    const activityName = this.getAttribute('data-activity-name');
                    const url = this.getAttribute('data-pic-url');

                    openViewModal(id, activityName, url);
                });
            });

            document.querySelectorAll('.pic-delete-button').forEach(button => {
                button.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const id = this.getAttribute('data-id');

                    showCustomConfirm('정말로 이 항목을 삭제하시겠습니까?', function () {
                        deleteActivityPic(id)
                            .then(() => {
                                refreshTable();
                            });
                    });
                });
            });
        }

        function handleConfirm() {
            if (isViewOnly) {
                const url = document.getElementById('picUrl').value.trim();
                document.getElementById('imageUrl').value = url;
                closeModal();
                closePicManagerModal();
                return;
            }

            const activityName = document.getElementById('picActivityName').value.trim();
            const url = document.getElementById('picUrl').value.trim();

            if (!activityName) {
                showCustomAlert('활동명을 입력해주세요.');
                return;
            }

            if (!url) {
                showCustomAlert('URL을 입력해주세요.');
                return;
            }

            if (isEditing) {
                updateActivityPic(currentRowId, activityName, url)
                    .then(() => {
                        closeModal();
                        refreshTable();
                    })
                    .catch(error => {
                        console.error('저장 오류:', error);
                        showCustomAlert('데이터 저장 중 오류가 발생했습니다.');
                    });
            } else {
                showCustomConfirm('입력한 정보를 저장하시겠습니까?', function () {
                    addActivityPic(activityName, url)
                        .then(() => {
                            closeModal();
                            refreshTable();
                        })
                        .catch(error => {
                            console.error('저장 오류:', error);
                            showCustomAlert('데이터 저장 중 오류가 발생했습니다.');
                        });
                });
            }
        }
    </script>

    <div id="picManagerSystem" style="display: none;">
        <div id="picModalBackdrop" class="pic-modal-backdrop"></div>

        <div id="picManagerModal" class="pic-modal pic-manager-modal">
            <div class="pic-modal-header">
                <h2 style="font-size: 16px; margin: 0;">활동 사진 URL 관리</h2>
                <span id="picManagerCloseButton" class="pic-close-button">&times;</span>
            </div>
            <div class="pic-modal-body">
                <div class="pic-toolbar">
                    <button id="picAddButton" class="button primary">사진 추가</button>
                    <button id="picCancelInputButton" class="button primary">입력 취소</button>
                    <div class="pic-filter-container">
                        <input type="text" id="picFilterInput" placeholder="활동명 검색..." class="pic-filter-input">
                        <span id="picFilterClearButton" class="pic-close-button pic-filter-clear">&times;</span>
                    </div>
                </div>

                <div class="pic-table-container">
                    <table id="picTable">
                        <thead>
                            <tr>
                                <th>활동명</th>
                                <th>URL주소</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="picTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="picModal" class="pic-modal">
            <div class="pic-modal-header">
                <h2 style="font-size: 16px; margin: 0;">활동 사진 URL</h2>
                <span id="picCloseButton" class="pic-close-button">&times;</span>
            </div>
            <div class="pic-modal-body">
                <div class="pic-modal-content">
                    <div class="pic-left-column">
                        <div class="pic-input-group">
                            <label for="picActivityName">활동명</label>
                            <input type="text" id="picActivityName" placeholder="활동명을 입력하세요">
                        </div>
                        <div class="pic-input-group">
                            <label for="picUrl">URL 주소</label>
                            <input type="text" id="picUrl" placeholder="이미지 URL을 입력하세요">
                            <button id="picPreviewButton" class="button secondary">이미지 보기</button>
                        </div>
                    </div>
                    <div class="pic-right-column">
                        <div id="picPreviewContainer" class="pic-preview-container">
                            <img id="picPreviewImage" class="pic-preview-image" src="" alt="">
                        </div>
                    </div>
                </div>
            </div>
            <div class="pic-modal-footer" style="display: flex; justify-content: flex-end;">
                <button id="picCancelButton" class="button secondary" style="margin-right: 10px;">취소</button>
                <button id="picConfirmButton" class="button primary">확인</button>
            </div>
        </div>
    </div>

</body>

</html>